# 基板の設計

当然ですが基板を実際に作り始める前には液晶の仕様を調べる必要があります。早速
データシート[^16]を参照しました

## 液晶(_LS027B7DH01_)の仕様を調べる
### 特徴

- 5V単一電源で動作、低消費電力
- 2.7インチモノクロTFT液晶
- 400 x 240ドットで高解像度
- 液晶が画素メモリを保持 - コントローラのVRAMが不要
- 最大6本の信号が必要
- 画素の情報を保持したまま表示をオンオフできる端子がある（**`DISP`**）
- 画面焼け防止のためのモード選択及び駆動極性クロック入力端子がある
  （**`EXTMODE`/`EXCOMIN`**）

この液晶にはMISO出力がありません。マイコン視点では画素メモリを読み出せる方が
便利ですが昨今のSoCには十分小さいメモリでVRAMを用意できるので不要なのでしょう。
それに消費電力にも影響すると思われます。

この液晶の操作には最低3本の信号線が必要です：

- **SI/MOSI**：SPIマスターからのデータ線
- **SCLK/SCK**：SPIクロック線
- **SCS/CSL**：スレーブセレクト信号線
    - 他の一般的なSPIスレーブデバイスはLアクティブが主流です
      （よく見かけます）が、この液晶はHアクティブで動作します。

ブレークアウト基板ではこの他にSPI-SRAMのセレクト信号とMISO出力がピンヘッダに
つながっています。一方、表示をオンオフする端子をH固定、画面焼け防止モード
選択端子はL固定、クロック入力端子は開放してあります

### コマンドの種類
コマンドは全部で3種類しかありません。大別すると画素メモリを操作するかどうかで
2種類です。メモリ操作の内容はライン単位の内容を更新（書き換え）するか、全部
消去するか。そして操作しないほうは基本的に本当に何もしません。

コマンドの構成は3つに大別されます：

1. コマンドビットとダミービット合わせて8ビット
1. ライン指定のための8ビット
1. 画素メモリ更新時のデータ400ビットと転送のための16ビット

メモリ内容を更新するときだけは3番目の部分が必要ですが、全消しと”何もしない”時は
1−2番目だけ必要です。

#### 1 byte目:コマンドビットとダミービット {-}
コマンドビットは1バイト目の最初の3ビットで、1番目と3番めのビットの組み合わせで
コマンドを仕分けています。2ビット目は液晶の焼け付き防止のための駆動極性
指定ビットで、定期的に反転させる必要があります。

残り5ビットはダミーであり、`1`でも`0`でも構いませんが、`0`が推奨されています。

#### 2 byte目：ライン指定ビット {-}
このメモリ液晶シリーズの唯一厄介な点は2番めのライン番号指定です。ここの1バイト
だけLSBファーストで転送する必要があります。
_1ライン目は`0x01`ではなくて`0x80`です。_

#### 3~N byte目：画素データとその転送のためのビット群 {-}
画素データは画面左端を最初に送ります。エンディアンは考えません。1ラインごとに
400ビット分（つまり50バイト）を一時メモリに書き込み、続く16ビット（2バイト）で
画素メモリに転送されます。画素メモリ転送時のテータもダミーなので0xAAでも
0x55でも平気です。

### メモリ全消し
全消しします。_慈悲はない。_

2バイト送信します。コマンドビットを`0-X-1-XXXXX`として、2バイト目はダミー
データです。

![メモリ全消し](images/waves/clsBits.png)

<!-- static const uint8_t COM_INVERT = 0x00;    // 0-X-0-XXXXX
static const uint8_t CLEAR_SCREEN = 0x20;  // 0-X-1-XXXXX
static const uint8_t UPDATE = 0x80;        // 1-X-0-XXXXX -->
### メモリに書き込む
画素メモリを _1ライン単位で_ 更新します。ブラウン管の走査線のイメージです。
複数のラインをまとめて更新することもできます。

コマンドビットは`1-X-0-XXXXX`

### 何もしない（けど駆動極性反転に使える）
このコマンドは画素メモリの操作をしませんが、2番めのコマンドビットを反転するのに
用いられます。

コマンドビットは`0-X-0-XXXXX`で、MSBから2ビット目が反転すると駆動も反転します。

![COM反転](images/waves/cominvertBits.png)

## よくある質問？
### 5V単一で動くという話だけど...
この液晶は5V単一電源で動作させられますが、データシートでは信号電圧は3Vが
推奨されています。このブレークアウト基板では、SRAMの仕様に合わせて
レベルシフタと3.3V出力レギュレータを使って信号を3.3Vに変換しています。
5Vで動作するマイコンでも3.3V出力ならばハイレベルと認識するのでSRAMの出力を
読むことには支障がないと考えられそうです。

### 高解像度だけど...
400x240ドットが2.7インチに収まっているのはいままでにない高解像度で素晴らしいの
ですが、マイコンから操作する視点に立つと`400 x 240 = 96000`ドット分のメモリが必要に
なります。モノクロ2値で保持されているので[^11]実際は`96000 / 8 = 12000`バイト
ということになりますが、Arduinoでは外部メモリなしには考えられないサイズ[^12]です。
mbedなら品種によりますが動かせるので、筆者は当初から青mbedで実験していました。

### SRAMの存在意義
_擬似DMA_ というものをご存知でしょうか。ChaNさん[^13]の記事にパラレルバスでSRAMから
カラー液晶にデータを流しこむ方法として掲載されていたもの[^14]です。SRAMと液晶の
セレクト信号を同時に操作して、SRAMを読み出す操作が同時に液晶の書込みになる
というものです。CPUが読み出し操作をするので正しい意味でのDMAではありませんが、
それぞれを読み書きするよりは早く済みます（単純に半分程度の時間で済む）。

これをSPIバスで実現しました：SPI-SRAMと液晶のセレクト信号を同時に[^15]
イネーブルにして、読み出されたデータをそのまま液晶への命令にします。したがって
SRAMには画像データと液晶への命令データが書かれていなければなりません。

![疑似（なんちゃって）DMA](images/waves/persudoDMA.png)
<!--  -->
[^11]: ちなみにこれがカラー液晶だとRGB各1ビットだとしても少なくともこの3倍必要な計算に
なります。ﾑﾘﾀﾞﾅ
[^12]: ArduinoのメインマイコンATMega328のSRAMは2KBです。まぢ無理...
[^13]: http://elm-chan.org/index_j.html
[^14]: http://elm-chan.org/docs/avr/avrdma_j.html
[^15]: TODO:実際はSRAMの読み出し命令を書き込んでいる間、液晶はセレクトされません
[^16]: http://www.mouser.com/ds/2/365/LS027B7DH01-542063.pdf
