# 基板の設計

当然ですが基板を実際に作り始める前には液晶の仕様を調べる必要があります。早速
データシート[^16]を参照しました

## 液晶(_LS027B7DH01_)の仕様を調べる
### 特徴

- 5V単一電源で動作、低消費電力
- 2.7インチモノクロTFT液晶
- 400 x 240ドットで高解像度
- 液晶が画素メモリを保持 - コントローラのVRAMが不要
- 最大6本の信号が必要
- 画素の情報を保持したまま表示をオンオフできる端子がある（**`DISP`**）
- 画面焼け防止のためのモード選択及びクロック入力端子がある（**`EXTMODE`/`EXCOMIN`**）

この液晶にはMISO出力がありません。画素メモリを読み出せると便利ですが昨今の
SoCには十分小さいメモリでVRAMを用意できるので不要なのでしょう。

この液晶の操作には最低3本の信号線が必要です：

- **SI/MOSI**：SPIマスターからのデータ線
- **SCLK/SCK**：SPIクロック線
- **SCS/CSL**：スレーブセレクト信号線
    - 他の一般的なSPIスレーブデバイスはLアクティブが主流です
      （よく見かけます）が、この液晶はHアクティブで動作します。

ブレークアウト基板ではこの他にSPI-SRAMのセレクト信号とMISO出力がピンヘッダに
つながっています。一方、表示をオンオフする端子をH固定、画面焼け防止モード
選択端子はL固定、クロック入力端子は開放してあります

### 5V単一で動くという話だけど...
この液晶は5V単一電源で動作させられますが、データシートでは信号電圧は3Vが
推奨されています。このブレークアウト基板では、SRAMの仕様に合わせて
レベルシフタと3.3V出力レギュレータを使って信号を3.3Vに変換しています。
5Vで動作するマイコンでも3.3V出力ならばハイレベルと認識するのでSRAMの出力を
読むことには支障がないと考えられそうです。

### 高解像度だけど...
400x240ドットが2.7インチに収まっているのはいままでにない高解像度で素晴らしいの
ですが、マイコンから操作する視点に立つと`400 x 240 = 96000`ドット分のメモリが必要に
なります。モノクロ2値で保持されているので[^11]実際は`96000 / 8 = 12000`バイト
ということになりますが、Arduinoでは外部メモリなしには考えられないサイズ[^12]です。
mbedなら品種によりますが動かせるので、筆者は当初から青mbedで実験していました。

### SRAMの存在意義
_擬似DMA_ というものをご存知でしょうか。ChaNさん[^13]の記事にパラレルバスでSRAMから
カラー液晶にデータを流しこむ方法として掲載されていたもの[^14]です。SRAMと液晶の
セレクト信号を同時に操作して、SRAMを読み出す操作が同時に液晶の書込みになる
というものです。CPUが読み出し操作をするので正しい意味でのDMAではありませんが、
それぞれを読み書きするよりは早く済みます（単純に半分程度の時間で済む）。

これをSPIバスで実現しました：SPI-SRAMと液晶のセレクト信号を同時に[^15]
イネーブルにして、読み出されたデータをそのまま液晶への命令にします。したがって
SRAMには画像データと液晶への命令データが書かれていなければなりません。

<!--  -->
[^11]: ちなみにこれがカラー液晶だとRGB各1ビットだとしても少なくともこの3倍必要な計算に
なります。ﾑﾘﾀﾞﾅ
[^12]: ArduinoのメインマイコンATMega328のSRAMは2KBです。まぢ無理...
[^13]: http://elm-chan.org/index_j.html
[^14]: http://elm-chan.org/docs/avr/avrdma_j.html
[^15]: TODO:実際はSRAMの読み出し命令を書き込んでいる間、液晶はセレクトされません
[^16]: http://www.mouser.com/ds/2/365/LS027B7DH01-542063.pdf
