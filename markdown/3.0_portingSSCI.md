# mbedライブラリをスイッチサイエンスのカラーメモリ液晶に移植する話

先述の通り現在**ssci**ブランチでmbedライブラリの移植を行っています。ここではその概要を説明します。

```table
---
# caption:
alignment: C
# table-width:
markdown: True
# inline markdown
# include:
header: False
---
`$ git clone -b ssci git@github.com:K4zuki/AkiSpiLcd.git`
```

## スイッチサイエンス版メモリ液晶の仕様
### **JDI(Japan Display Inc.) LPM013M126A**{-}
- 3.3V単一電源で動作
- 1.8インチ８色カラー液晶
    - 3bitモード
    - 4bitモード
    - 1bitモード
- 176x176ドットの解像度

```table
---
caption: 主な仕様（データシートから抜粋）
alignment: CCCC
markdown: True
table-width: 0.8
width:
    - 0.05
    - 0.35
    - 0.35
    - 0.05
---
No.,FACTOR, SPECIFICATIONS, UNIT
1,LCD structure,LTPS (Memory in Pixel type),
2,Outward ^\\*1^,"(W x H x D)\\
26.02 x 27.82 x 0.844 ^\\*1^",mm
3,Weight, 1.2(typ.), g
4,Screen size,23.02(H) x 23.02(V) (1.282 inch), mm
5,Resolution, 176 x RGB x176, dot
6,Dot pitch,"(Horizontal x Vertical)\\
0.0436 x 0.1308", mm
7,Dot layout, RGB stripe,
8,Liquid crystal mode, ECB normally black (Reflective type),
9,Polarizer,"Hard Coat type\\
(*Pencil Hardness : 2H)",
```

<sub>*1 ) Excluding FPC and part of protruding.</sub>

---

秋月メモリ液晶と異なるのは動作電圧、解像度、コマンド仕様（カラー設定）、_ライン番号指定が素直になったこと_ の４点です。
フレキの大きさ、向き、ピン配置は互換性があります。

### 動作電圧範囲が３Ｖ系になった

シャープ系は5V電源、3V信号の組み合わせでしたが、JDIのこの液晶は電源・信号とも3.3V単一電源で動作します。

```table
---
caption: 定格電源仕様（データシートから抜粋）
alignment: CCCCCCC
markdown: True
table-width: 0.8
width:
    - 0.45
    - 0.10
    - 0.15
    - 0.05
    - 0.10
    - 0.05
    - 0.10
---
PARAMETER,SYMBOL,Min.,Typ.,Max.,UNIT,REMARKS
Power supply voltage Analog,VDDA,2.7,3.0,VDD,V,
,VSSA,,0,,V,
Power supply voltage Logic,VDD,2.7,3.0,3.3,V,(\*3-1)
,VSS,,0,,V,(*3-2)
Input signal voltage Hi,VIH,VDD-0.1,3.0,VDD,V,(\*3-3)
Input signal voltage Lo,VIL,VSS,VSS,VSS+0.1,V,(\*3-3)
```

- (\*3-1) Apply to EXTMODE=“H”
- (\*3-2) Apply to EXTMODE=“L”
- (\*3-3) Apply to SCLK, SI, SCS, DISP, EXTCOMIN

***

\\newpage

絶対最大定格は**3.6V**なので、Arduinoの信号を直結すると壊れるか、少なくとも液晶が劣化すると考えられます。
**Arduinoから制御するときはレベルシフタを入れるなどの5V-3V変換が必要です。**

```table
---
caption: 絶対最大定格（データシートから抜粋）
alignment: CCCCD
markdown: True
table-width: 0.8
width:
    - 0.4
    - 0.1
    - 0.1
    - 0.1
    - 0.1
---
PARAMETER, SYMBOL, RATINGS, UNIT, REMARKS
Power supply voltage Analog, VDDA, 3.6, V,
Power supply voltage Logic, VDD, 3.6, V,
Input signal voltage Hi, VIH, 3.6, V,
```

### 解像度が小さくなったからメモリも少なくていい？

_はいともいいえとも言えます。_ JDIの液晶の解像度は176x176ドットで、秋月の液晶に比べて3割程度です。
しかし1ドットあたり3ビットの色情報を保持するのでそこから3倍に膨れ上がります。ダミーを入れて4ビット/ドット
にもできるのでむしろ2割増しぐらいにもなりえます。
したがって秋月液晶と同等のグラフィックメモリを用意しなければならない[^31]のです。

[^31]: JDI液晶にも白黒モードがあり、そのときは1ビット/ドットで済むのですが、それでも4kB弱必要です。

### _素直な_ ライン番号指定（だいじ）

秋月メモリ液晶とそのサイズ違いのシリーズは全部ビット順が反転したライン指定方法を取っていますが、
スイッチサイエンスのは**素直**です。１ライン目が`0x01`です。

### コマンド仕様
データシートを読むと、ちょっと複雑なフローチャート図でコマンドが説明されています。
複雑になった理由はシャープ系との互換性を保ったままコマンド種類を拡張したためと考えられます。
シャープ系でダミー扱いされていたビットも有効になったのでフローチャートが細かくなってます。

ビットフィールドは以下のような感じです。

![JDI液晶のコマンドビット](images/bitfield16/jdicommandbits.png)

```{.mermaid loc=images/mermaid-filter}
%% Example diagram
graph TD
    SI[Start] --> M0{Mode Select M0}

    M0 -->|M0 = H| M2{Mode Select M2}

    M0 -->|M0 = L| M[Function Mode]
    M --> MM{Mode Select M2}
    MM -->|M2 = H| C[All Clear Flag]
    MM -->|M2 = L| N[No Update Mode]
    C --> M3{Mode Select M3}
    N --> M3
    M3 -->|M3 = L| T[Blinking OFF]
    M3 -->|M3 = H| B[Blinking ON]
    B --> M5{Inversion Flag M5}
    M5 -->|M5 = H| I[Inversion Display]
    M5 -->|M5 = L| M4{Color Flag M4}
    M4 -->|M4 = L| BK[Black Display]
    M4 -->|M4 = H| WH[White Display]
```

#### No-Update

![何もしない](images/bitfield16/jdinoupdate.png)

#### No-Update?

Mode Selectの表で下の組み合わせもNo-Updateと書かれていますが、
フローチャートをたどるとBlinking OFFの組み合わせです。
画面点滅が有効なときは点滅が止まって、点滅していない時は何も起きない
ということだと考えられます。

![点滅停止](images/bitfield16/jdiblinkoff.png)

#### Blinking
#### All Clear
#### Data update
## mbedライブラリの更新

解像度が異なることとカラーモードが指定できることから、今の**ssci**ブランチは親クラス(MemoryLCD)に共通項を
集め、子クラスとしてAkiSpiLcdクラスとSsciSpiLcdクラスが実装されています。

```{.mermaid loc=images/mermaid-filter}
%% Example diagram
graph BT
    AkiSpiLcd ==> MemoryLCD
    SsciSpiLcd ==> MemoryLCD
```

## 小さな液晶、小さな基板でいいじゃない
